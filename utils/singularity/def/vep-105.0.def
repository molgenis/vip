Bootstrap: localimage
From: sif/build/alpine-3.15.0.sif
Stage: build

%post
    version_major=1
    version_minor=14

    apk --no-cache add -X http://dl-cdn.alpinelinux.org/alpine/edge/community curl build-base zlib-dev bzip2-dev xz-dev libdeflate-dev

    # download
    curl -Ls -o "htslib-${version_major}.${version_minor}.tar.bz2" "https://github.com/samtools/htslib/releases/download/${version_major}.${version_minor}/htslib-${version_major}.${version_minor}.tar.bz2"
    echo "ed221b8f52f4812f810eebe0cc56cd8355a5c9d21c62d142ac05ad0da147935f  htslib-${version_major}.${version_minor}.tar.bz2" | sha256sum -c

    # install
    tar -xf "htslib-${version_major}.${version_minor}.tar.bz2"
    cd "htslib-${version_major}.${version_minor}"
    ./configure --disable-libcurl --disable-gcs --disable-s3
    make
    make install

Bootstrap: localimage
From: sif/build/alpine-3.15.0.sif
Stage: final

%help
    VEP (Variant Effect Predictor) predicts the functional effects of genomic variants.

%files from build
    /usr/local/bin/bgzip
    /usr/local/bin/tabix

%post
    version_major=105
    version_minor=0

    apk update
    apk add -X http://dl-cdn.alpinelinux.org/alpine/edge/community perl perl-dbi zlib libbz2 xz-libs libdeflate
    apk add --virtual=.build-dependencies -X http://dl-cdn.alpinelinux.org/alpine/edge/community curl git build-base zlib-dev bzip2-dev xz-dev perl-module-build perl-dev perl-app-cpanminus wget libdeflate-dev

    curl -Ls -o ensembl-vep.tar.gz "https://github.com/Ensembl/ensembl-vep/archive/refs/tags/release/${version_major}.${version_minor}.tar.gz"
    echo "cc3bc077cecc8e08b935192d6e50b927ea1058a129abaf2c960cbfe24422a9c5  ensembl-vep.tar.gz" | sha256sum -c

    curl -Ls -o ensembl-xs.tar.gz https://github.com/Ensembl/ensembl-xs/archive/refs/tags/2.3.2.tar.gz
    echo "aafc59568cd1042259196575e99cdfeef9c0fb7966e5f915cfaf38c70885ffa5  ensembl-xs.tar.gz" | sha256sum -c

    # install
    cpanm https://cpan.metacpan.org/authors/id/E/ET/ETHER/Try-Tiny-0.30.tar.gz
    cpanm https://cpan.metacpan.org/authors/id/I/IS/ISHIGAKI/JSON-4.03.tar.gz
    cpanm https://cpan.metacpan.org/authors/id/S/SL/SLOYD/Set-IntervalTree-0.12.tar.gz
    cpanm https://cpan.metacpan.org/authors/id/N/NW/NWCLARK/PerlIO-gzip-0.20.tar.gz

    tar xf ensembl-vep.tar.gz -C /usr/share
    TARGET_DIR="/usr/share/ensembl-vep-release-${version_major}.${version_minor}"
    (
       cd "${TARGET_DIR}"
       perl INSTALL.pl --AUTO a --NO_UPDATE
    )
    echo "export PATH=\"$PATH:${TARGET_DIR}\"" >> "${SINGULARITY_ENVIRONMENT}"

    tar xf ensembl-xs.tar.gz
    (
       cd ensembl-xs-2.3.2
       perl Makefile.PL
       make
       make install
    )

    # cleanup
    apk del .build-dependencies
    rm -rf /var/cache/apk/* ensembl-xs.tar.gz ensembl-vep.tar.gz
